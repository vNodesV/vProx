name: Required Reviewer Approval

on:
  pull_request:
    branches: [main]
    types: [opened, reopened, synchronize, ready_for_review, review_requested, edited]
  pull_request_review:
    types: [submitted, edited, dismissed]

permissions:
  contents: read
  pull-requests: read

jobs:
  required-reviewer-approval:
    name: Required reviewer approved
    runs-on: ubuntu-latest
    if: github.base_ref == 'main'

    steps:
      - name: Verify required reviewer approval
        uses: actions/github-script@v7
        env:
          REQUIRED_REVIEWER: vNodesV
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.issue.number;
            const requiredReviewer = process.env.REQUIRED_REVIEWER;

            let allReviews = [];
            let page = 1;

            while (true) {
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number,
                per_page: 100,
                page,
              });

              allReviews = allReviews.concat(reviews);

              if (reviews.length < 100) {
                break;
              }

              page += 1;
            }

            const latestStateByUser = new Map();
            for (const review of allReviews) {
              if (!review.user || !review.user.login) continue;
              latestStateByUser.set(review.user.login, review.state);
            }

            const requiredState = latestStateByUser.get(requiredReviewer);

            if (requiredState !== 'APPROVED') {
              core.setFailed(
                `PR must have an active APPROVED review from @${requiredReviewer}. Current state: ${requiredState || 'none'}`
              );
              return;
            }

            core.info(`Verified APPROVED review from @${requiredReviewer}.`);